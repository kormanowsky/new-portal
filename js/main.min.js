/**
  NewPortal
  Версия: 0.0.1
  Дата выпуска:
  Автор: Михаил Кормановский
  Описание: Скрипт изменяет дизайн Школьного портала на более современный. Автор скрипта не собирает какие-либо персональные данные пользователей Школьного портала, скрипт выполняется на компьютере конечного пользователя с его разрешения.
  Задача скрипта - изменить представление выдаваемой серверами Школьного портала информации.
  Сторонние ресурсы, включая собственные:
    - jQuery (https://jquery.com)
    - jExtract (https://github.com/kormanowsky/jextract)
    - Calendar for NewPortal
    - Chart.js (https://chartjs.org)
    - Moment.js (https://momentjs.com)
    - Mustache (https://mustache.github.io)
    - Bootstrap (https://getbootstrap.com/)
    - LineAwesome (https://icons8.com/line-awesome)
  Логотип Школьного портала является собсвенностью владельцев Школьного портала.
  Сторонние ресурсы являются собственностью их авторов.
  main.min.js
*/
jQuery(function(e){var t=function(e){return void 0!==e},a=window.NewPortal={colors:["#21af21","#f4d909","#ff8900","#fa4f15","#0470be"],periods:{_:[{full:"триместр",short:"тр"},{full:"четверть",short:"чтв"}],getFull:function(e){var n;return a.periods._.forEach(function(t,a){t.short==e&&(n=t.full)}),n=t(n)?n:e},getShort:function(e){var n;return a.periods._.forEach(function(t,a){t.full==e&&(n=t.short)}),n=t(n)?n:e}},urls:{extension:{base:chrome.runtime.getURL(""),templates:chrome.runtime.getURL("templates/"),getTemplateURL:function(e){return a.urls.extension.templates+e+".html"}},current:window.location.href},getters:{date:function(e,t,n){var r,s=e.get();return r="Вчера"==s?moment().subtract(1,"day"):"Сегодня"==s?moment():moment(a.formatters.date(s),"YYYY-MM-DD"),"format"!=n?r[n]():r[n]("MMMM YYYY")},average:function(e){var t=0,a=e.length;return a?(e.forEach(function(e){t+=e}),t/a):0},missing:function(e){var t={};switch(e.get()){case"Болеет":t.type="b",t.typeRU="Б";break;case"Неявка":t.type="n",t.typeRU="Н";break;case"Пропуск":t.type="p",t.typeRU="П";break;case"":t.type=!1,t.typeRU=!1;break;default:t.type="p",t.typeRU="П"}return t}},formatters:{date:function(e){return moment.localeData()._months.format.forEach(function(t,a,n){e=e.replace(t,"-"+(a+1)+"-").replace(/\s/g,"")}),e=e.split("-").reverse().join("-")},avatar:function(e,t){return t=t||!0,t?e.replace(".s.",".l."):e.replace(".l.",".s.")},background:function(e){return e=+e,e>=4.5?"e":e>=3.5?"g":e>=2.5?"n":"b"},pageTitle:function(e){return[{old:"По триместрам",now:"Успеваемость по периодам"},{old:"Успеваемость",now:"Дневник"},{old:"По предметам",now:"Успеваемость по предмету"},{old:"Итоговые",now:"Итоговые оценки"}].forEach(function(t){t.old==e.trim()&&(e=t.now)}),e}},parsers:{methods:{getStudentInfo:function(){return{student:jExtract({name:"h2",year:[".player:nth-of-type(2)",{text:"h3",prev:[".pB a",["attr","href"]],next:[".pF a",["attr","href"]]}]})}}},current:null,all:[{regexp:"http[s]?://schools.school.mosreg.ru/marks.aspx?(.*)([tab=week]?)(.*)",template:"diary",title:"Дневник",beforeHeader:{template:'<div id="student-info" class="row no-margin"> <div id="student-info-name">{{student.name}}</div>{{#student.year.prev}}<div id="student-info-year-prev"> <a href="{{student.year.prev}}"><i class="la la-long-arrow-left"></i></a> </div>{{/student.year.prev}}<div id="student-info-year-title">{{student.year.text}}</div>{{#student.year.next}}<div id="student-info-year-next"> <a href="{{student.year.next}}"><i class="la la-long-arrow-right"></i></a> </div>{{/student.year.next}}</div>',generator:function(){return a.parsers.methods.getStudentInfo()}},afterHeader:{template:'<div id="diary-header"><div id="diary-prev"> <a href="{{prev}}"><i class="la la-long-arrow-left"></i></a> </div><div id="diary-title">{{title}}</div><div id="diary-next"> <a href="{{next}}"><i class="la la-long-arrow-right"></i></a> </div></div>',generator:function(){return jExtract({title:".inl h3",next:[".player .pF a",["attr","href"]],prev:[".player .pB a",["attr","href"]]})}},generator:function(){return jExtract({days:["#diarydaysleft .col24, #diarydaysright .col24",{ofWeek:["h3:nth-child(1)",[],["match",new RegExp(/([А-Я][а-я]+)/),0]],num:["h3:nth-child(1)",[],["match",new RegExp(/([0-9]+)/),0]],lessons:[".marks tr",{name:"td:nth-child(1) a",missing:{back:["td:nth-child(2) span",[],function(e){var t="p";switch(e.get()){case"П":t="p";break;case"Б":t="b";break;case"Н":t="n"}return"m-"+t}],type:"td:nth-child(2) span"},url:["td:nth-child(1) a",["attr","href"]],homework:["td:nth-child(5) a",{href:[".",["attr","href"]],text:"."}],marks:["td:nth-child(3) .mark",[],"toInt"]}]}]})}},{regexp:"http[s]?://schools.school.mosreg.ru/marks.aspx?(.*)tab=stats(.*)",template:"stats",title:"Статистика",beforeHeader:{template:'<div id="student-info" class="row no-margin"> <div id="student-info-name">{{student.name}}</div>{{#student.year.prev}}<div id="student-info-year-prev"> <a href="{{student.year.prev}}"><i class="la la-long-arrow-left"></i></a> </div>{{/student.year.prev}}<div id="student-info-year-title">{{student.year.text}}</div>{{#student.year.next}}<div id="student-info-year-next"> <a href="{{student.year.next}}"><i class="la la-long-arrow-right"></i></a> </div>{{/student.year.next}}</div>',generator:function(){return a.parsers.methods.getStudentInfo()}},afterHeader:{template:'<div class="after-title-links">{{#periods}}<a href="{{href}}"{{#active}}class="active"{{/active}}>{{name}}</a>{{/periods}}</div>',generator:function(){return jExtract({periods:[".switch li",{active:[".",function(e){return e.hasClass("active")}],name:"a",href:["a",["attr","href"]]}]})}},generator:function(){return jExtract({subjects:[".marks tbody tr",{name:"td:nth-of-type(2) a",url:["td:nth-of-type(2) a",["attr","href"]],marks2:["td:nth-of-type(6)",[],"toInt"],marks3:["td:nth-of-type(5)",[],"toInt"],marks4:["td:nth-of-type(4)",[],"toInt"],marks5:["td:nth-of-type(3)",[],"toInt"],success:["td:nth-of-type(7)",[],"toInt"]}]})},ready:function(t){setTimeout(function(){t.subjects.forEach(function(t,n,r){new Chart(e(".stats-subject-chart").eq(n),{type:"pie",data:{labels:['Оценок "5"','Оценок "4"','Оценок "3"','Оценок "2"'],datasets:[{label:"&nbsp;",data:[t.marks5,t.marks4,t.marks3,t.marks2],backgroundColor:a.colors,borderWidth:0}]},options:{legend:{display:!1},tooltips:{cornerRadius:0,bodyFontFamily:"'Fira Sans', sans-serif"}}})})},200)}},{regexp:"http[s]?://schools.school.mosreg.ru/marks.aspx?(.*)tab=period(.*)",template:"period",beforeHeader:{template:'<div id="student-info" class="row no-margin"> <div id="student-info-name">{{student.name}}</div>{{#student.year.prev}}<div id="student-info-year-prev"> <a href="{{student.year.prev}}"><i class="la la-long-arrow-left"></i></a> </div>{{/student.year.prev}}<div id="student-info-year-title">{{student.year.text}}</div>{{#student.year.next}}<div id="student-info-year-next"> <a href="{{student.year.next}}"><i class="la la-long-arrow-right"></i></a> </div>{{/student.year.next}}</div>',generator:function(){return a.parsers.methods.getStudentInfo()}},afterHeader:{template:'<div class="after-title-links">{{#periods}}<a href="{{href}}"{{#active}}class="active"{{/active}}>{{name}}</a>{{/periods}}</div>',generator:function(){return jExtract({periods:[".switch li",{active:[".",function(e){return e.hasClass("active")}],name:"a",href:["a",["attr","href"]]}]})}},title:"Успеваемость по периодам",generator:function(){var e=function(e,t,a){return t<1?a.length:null};return jExtract({subjects:["#journal tbody tr:not(:nth-of-type(1)):not(:nth-of-type(2))",{name:"td:nth-of-type(2) a",marks:["td:nth-of-type(3) .mark",function(e,t,a){return isNaN(parseInt(e.text()))?null:e.text()}],average:["td:nth-of-type(7) .mark",[],"toFloat"],lates:["td:nth-of-type(4)",[],"toInt"],missings:{typeP:[".lsB:contains('П')",e,"toInt"],typeB:[".lsB:contains('Б')",e,"toInt"],typeN:[".lsR:contains('Н')",e,"toInt"]}}]})}},{regexp:"http[s]?://schools.school.mosreg.ru/marks.aspx?(.*)tab=subject(.*)",template:"subject",title:"Успеваемость по предмету",beforeHeader:{template:'<div id="student-info" class="row no-margin"> <div id="student-info-name">{{student.name}}</div>{{#student.year.prev}}<div id="student-info-year-prev"> <a href="{{student.year.prev}}"><i class="la la-long-arrow-left"></i></a> </div>{{/student.year.prev}}<div id="student-info-year-title">{{student.year.text}}</div>{{#student.year.next}}<div id="student-info-year-next"> <a href="{{student.year.next}}"><i class="la la-long-arrow-right"></i></a> </div>{{/student.year.next}}</div>',generator:function(){return a.parsers.methods.getStudentInfo()}},afterHeader:{template:'<form action="{{changeSubject.action}}" method="get" id="subject-change-form"> <input type="hidden" id="school" name="school" value="2000000029883"> <input type="hidden" id="index" name="index" value="2"> <input type="hidden" id="tab" name="tab" value="subject"> <label for="subject-change-subject"> Предмет: <select name="subject" id="subject-change-subject">{{#changeSubject.subjectOptions}}<option value="{{value}}"{{#selected}}selected{{/selected}}>{{text}}</option>{{/changeSubject.subjectOptions}}</select> </label> <label for="subject-change-period"> Период: <select name="period" id="subject-change-period">{{#changeSubject.periodOptions}}<option value="{{value}}"{{#selected}}selected{{/selected}}>{{text}}</option>{{/changeSubject.periodOptions}}</select> </label> <button type="submit" id="subject-change-form-submit"> <i class="la la-long-arrow-right"></i> </button> </form>',generator:function(){return jExtract({changeSubject:{action:[".formSearch",["attr","action"]],subjectOptions:[".formSearch select#subject option",{value:[".",["attr","value"]],text:[".",[],function(e){return"- выберите -"==e.get()?"Не выбран":e.get()}],selected:[".",["attr","selected"]]}],periodOptions:[".formSearch select#period option",{value:[".",["attr","value"]],text:".",selected:[".",["attr","selected"]]}]}})}},generator:function(){var e,n=a.getters.date,r=a.getters.missing,s=a.getters.average,i=jExtract({lessons:[".marks tr:not(:nth-of-type(1))",{href:["td:nth-of-type(1) a",["attr","href"]],date:{day:["td:nth-of-type(1) a > b",[],[n,"date"]],month:["td:nth-of-type(1) a > b",[],[n,"month"]],year:["td:nth-of-type(1) a > b",[],[n,"year"]],monthTitle:["td:nth-of-type(1) a > b",[],[n,"format"]]},missing:["td:nth-of-type(2) a",[],[r]],marks:["td:nth-of-type(3) .mark",[],"toInt",!0]}]});return i.lessons&&i.lessons.length&&(e=[{month:i.lessons[0].date.month+1,year:i.lessons[0].date.year,title:i.lessons[0].date.monthTitle,lessons:[]}],i.lessons.forEach(function(e,n){var r;r=t(e.missing)?"m-"+e.missing.type:e.marks.length?a.formatters.background(s(e.marks)):"",i.lessons[n].background=r,i.lessons[n].marks=e.marks.join("/")}),i.lessons.forEach(function(t){var a=t.date.month+1,n=t.date.year,r=e[e.length-1];r.month!==a||r.year!==n?e.push({month:a,year:n,title:t.date.monthTitle,lessons:[t]}):e[e.length-1].lessons.push(t)})),{months:e,changeSubject:i.changeSubject,calendar:function(){var e=this.lessons;return Calendar(null,{month:this.month,year:this.year,tdGenerator:function(a,n,r){var s,i='{{#href}}<a href="{{href}}">{{/href}}<div class="subject-day-data back-{{background}}"><div class="subject-day">'+a+'</div>{{#missing}}<div class="subject-day-missing subject-day-missing-{{missing.type}}">{{missing.typeRU}}</div>{{/missing}}{{^missing}}<div class="subject-day-marks">{{marks}}</div>{{/missing}}</div>{{#href}}</a>{{/href}}';return e.forEach(function(e){e.date.day===a&&(s=Mustache.render(i,e))}),t(s)||(s='<div class="subject-day-data subject-day-no-subject"><div class="subject-day">'+a+"</div></div>"),s}}).getHtml()}}}},{regexp:"http[s]?://schools.school.mosreg.ru/marks.aspx?(.*)tab=result(.*)",title:"Итоговые оценки",template:"result",beforeHeader:{template:'<div id="student-info" class="row no-margin"> <div id="student-info-name">{{student.name}}</div>{{#student.year.prev}}<div id="student-info-year-prev"> <a href="{{student.year.prev}}"><i class="la la-long-arrow-left"></i></a> </div>{{/student.year.prev}}<div id="student-info-year-title">{{student.year.text}}</div>{{#student.year.next}}<div id="student-info-year-next"> <a href="{{student.year.next}}"><i class="la la-long-arrow-right"></i></a> </div>{{/student.year.next}}</div>',generator:function(){return a.parsers.methods.getStudentInfo()}},generator:function(){var t=e(".marks"),n=[];return t.find("tr").eq(0).find("th").each(function(r,s){if(!(r<=1)){var i={};i.name=[e(s).text().split(" ")[0],a.periods.getFull(e(s).text().split(" ")[1])].join(" "),i.marks=[],t.find("tr").each(function(t,n){var s=e(n).find("td");s.length&&s.eq(r).find("a, .mG, .mY, .mX, .mR, .mO").text().length&&i.marks.push({mark:s.eq(r).find("a, .mG, .mY, .mX, .mR, .mO").text(),subject:s.eq(1).find("a").text(),background:a.formatters.background(+s.eq(r).find("a, .mG, .mY, .mX, .mR, .mO").text())})}),i.marks.length&&n.push(i)}}),{periods:n}}}],main:{getData:function(){var n=jExtract({menu:[".header-menu__item",{href:[".header-menu__link",["attr","href"]],text:".header-menu__link",active:[".",["hasClass","header-menu__item_active"]],submenu:[".header-submenu",{active:[".",["hasClass","header-submenu_active"]],items:[".header-submenu__item",{href:[".header-submenu__link",["attr","href"]],text:".header-submenu__link",active:[".",["hasClass","header-submenu__item_active"]]}]}]}],tabs:[".tabs li:not(.active)",{href:["a",["attr","href"]],text:["a",[],function(e){return a.formatters.pageTitle(e.get())}]}],currentUser:{name:".user-profile-box__initials",avatar:[".user-profile-box__avatar > img",["attr","src"],function(e){return a.formatters.avatar(e.get())}]},footerMenu:[".page-footer__menu-item a, .page-footer__copyright-layout>a:nth-of-type(1)",{href:[".",["attr","href"]],text:"."}]});n.menu[n.menu.length-1].text="Настройки",n.menu.push({href:e(".user-profile-box .dropdown-container a:last-of-type").attr("href"),text:"Выход",active:!1,submenu:[]}),n.title=a.parsers.current.title,n.base=a.urls.extension.base,n.hasTabs=!!t(n.tabs)&&!!n.tabs.length;var r=moment().year();return n.originalYears=r>2015?"2015-"+r:"2015",n.newPortalYears=r>2017?"2017-"+r:"2017",n},ready:function(){e("#search-open").click(function(t){t.preventDefault(),e("#search-form").show(),e("#search-wrap").css("z-index",5),setTimeout(function(){e("#search-open").attr("id","search-submit")},100)}),e("#search-close").click(function(t){t.preventDefault(),e("#search-form").hide(),e("#search-wrap").css("z-index",2),setTimeout(function(){e("#search-submit").attr("id","search-open")},100)}),e("#open-menu").click(function(t){t.preventDefault(),e("#main-menu, #main-menu-layer").addClass("visible"),e("body").addClass("menu-open"),e(window).width()<=768&&(e("#open-menu i").toggleClass("la-bars la-close"),setTimeout(function(){e("#open-menu").attr("id","close-menu")},100))}),e("body").on("click","#main-menu-layer, #close-menu",function(t){t.preventDefault(),e("#main-menu, #main-menu-layer").removeClass("visible"),e("body").removeClass("menu-open"),e("#close-menu i").toggleClass("la-bars la-close"),setTimeout(function(){e("#close-menu").attr("id","open-menu")},100)}),e("body").on("click","#search-submit",function(t){t.preventDefault(),e("#search").submit()}),e("#open-tabs").click(function(t){t.preventDefault(),e("h1 nav").show(),e("#open-tabs i").toggleClass("la-angle-up la-angle-down"),setTimeout(function(){e("#open-tabs").attr("id","close-tabs")},100)}),e("body").on("click","#close-tabs",function(t){t.preventDefault(),e("h1 nav").hide(),e("#close-tabs i").toggleClass("la-angle-down la-angle-up"),setTimeout(function(){e("#close-tabs").attr("id","open-tabs")},100)}),e("body").on("click",".open-main-menu-submenu",function(t){t.preventDefault(),e(".main-submenu.visible").removeClass("visible"),e(".close-main-menu-submenu").toggleClass("open-main-menu-submenu close-main-menu-submenu"),e(".toggle-main-menu-submenu").find("i").removeClass("la-angle-up").addClass("la-angle-down"),e(this).parents("li.main-menu-item").find(".main-submenu").addClass("visible"),e(this).find("i").toggleClass("la-angle-down la-angle-up"),e(this).toggleClass("open-main-menu-submenu close-main-menu-submenu")}),e("body").on("click",".close-main-menu-submenu",function(t){t.preventDefault(),e(".main-submenu.visible").removeClass("visible"),e(this).find("i").toggleClass("la-angle-down la-angle-up"),e(this).toggleClass("open-main-menu-submenu close-main-menu-submenu")}),e(window).scrollTop()>64?(e("body").addClass("header-small"),e("header").addClass("small")):(e("body").removeClass("header-small"),e("header").removeClass("small")),e(window).on("scroll",function(){e(this).scrollTop()>64?(e("body").addClass("header-small"),e("header").addClass("small")):(e("body").removeClass("header-small"),e("header").removeClass("small"))}),e(".preloading").removeClass("preloading")}}},document:{element:function(){return document.getElementsByTagName("html")[0]},title:function(){return e("title").text()}},locale:"ru",version:"0.0.1",pageSupported:!1,init:function(){e(".error").length?a.pageSupported=!0:(a.parsers.all.forEach(function(e,t,n){new RegExp(e.regexp).test(a.urls.current)&&(a.parsers.current=e,a.pageSupported=!0)}),a.pageSupported&&e.get(a.urls.extension.getTemplateURL("main"),function(n){e.get(a.urls.extension.getTemplateURL(a.parsers.current.template),function(r){var s=a.parsers.current.generator(),i=Mustache.render(r,s),o=a.parsers.main.getData(),l={content:i};if(t(a.parsers.current.beforeHeader)){var d=a.parsers.current.beforeHeader.template,u=a.parsers.current.beforeHeader.generator();l.beforeHeader=Mustache.render(d,u),o.hasBeforeHeader=!0}if(t(a.parsers.current.afterHeader)){var c=a.parsers.current.afterHeader.template,m=a.parsers.current.afterHeader.generator();l.afterHeader=Mustache.render(c,m),o.hasAfterHeader=!0}page=Mustache.render(n,o,l),a.document.element().innerHTML=page,e(document).ready(function(){"function"==typeof a.parsers.current.ready&&a.parsers.current.ready(s),a.parsers.main.ready(),function(){var t=0,a=e(".before-animation"),n=setInterval(function(){t!=a.length?(a.eq(t).removeClass("before-animation"),a.eq(t).removeClass("before-animation"),++t):clearInterval(n)},100-4*a.length)}()})})}))}};moment.locale(a.locale),a.init(),a.pageSupported||(e("body").append('<div style="position: absolute;top: 0;right: 0;left: 0;text-align: center;font-size: 14px;height: 28px;color: white;line-height: 28px;background: #0172b2;padding: 10px;">К сожалению, данная страница пока не поддрерживается NewPortal. Отображается оригинальный Школьный Портал.</div>'),e("body").css("margin-top","48px"))});
